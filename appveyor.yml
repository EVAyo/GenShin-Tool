version: '4.0.{build}'
os: Visual Studio 2017
configuration: Release
platform:
    - x64
branches:
  only:
    - master

environment:
  MyProjectDir: C:\projects\genshinimpact-autotrack-dll\
  OpenCvDir: C:\projects\opencv\
  OpenCvUrl: https://github.com/GengGode/opencv450Release/releases/download/v1.0/Release.zip
skip_tags: true
  
install:
    - ps: $env:TIME_STRING=(get-date -UFormat "%Y%m%d%a").ToString()

    # download opencv:
    - mkdir %OpenCvDir%
    #- dir %OpenCvDir%
    - appveyor DownloadFile %OpenCvUrl%
    - 7z x ./*.zip -y -o%OpenCvDir%
    - rm -f ./*.zip
    #- dir %OpenCvDir%
    #- dir %OpenCvDir%x64\vc15\staticlib
    
before_build: 
    #- dir  %MyProjectDir%
    #- dir  %OpenCvDir%

build_script:
    - MSBuild %MyProjectDir%cvAutoTrack\cvAutoTrack.vcxproj

after_build:
    # copy include and source code files
    #- ls
    - mkdir %MyProjectDir%x64\build\
    - ps: cp -r $env:MyProjectDir\cvAutoTrack\x64\Release\*.dll $env:MyProjectDir\x64\build\

    - 7z a cvautotrack-$(APPVEYOR_BUILD_VERSION).7z %MyProjectDir%x64\build\*
    - appveyor PushArtifact cvautotrack-%TIME_STRING%.7z
    
#artifacts:
    #- path: build/Release
    #artifacts path name must be appveyor API
  
deploy:
    - provider: GitHub
      description: '$(APPVEYOR_BUILD_VERSION) Updata Dll' 
      auth_token:
         secure: G/Fzf0bGIhqqt+XvsC5AXrZVNs3atGU7XCzJxqiUZEwOxoZrjxk87ENI/OitnXCo
      draft: false
      tag: $(APPVEYOR_BUILD_VERSION)-AutoTrack-%TIME_STRING%
      force_update: true
      on:  
        APPVEYOR_REPO_TAG: false
